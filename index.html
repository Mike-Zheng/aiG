<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>WebP å‹•ç•«åœ–åº« - æ¥µè‡´æ•ˆèƒ½å±•ç¤º</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      line-height: 1.6;
    }

    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .subtitle {
      font-size: 14px;
      opacity: 0.9;
    }

    .stats {
      display: flex;
      gap: 20px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .stat {
      background: rgba(255,255,255,0.2);
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
    }

    .instructions {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .instructions h2 {
      font-size: 18px;
      margin-bottom: 12px;
      color: #333;
    }

    .instructions ul {
      padding-left: 20px;
      color: #666;
    }

    .instructions li {
      margin-bottom: 8px;
    }

    .instructions code {
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      margin: 0 auto 20px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .gallery-item {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
      position: relative;
    }

    .gallery-item:active {
      transform: scale(0.98);
    }

    .gallery-item:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    .gallery-item img {
      width: 100%;
      height: auto;
      display: block;
      -webkit-user-select: none;
      user-select: none;
    }

    .gallery-item .label {
      padding: 10px;
      font-size: 12px;
      color: #666;
      text-align: center;
      background: #fafafa;
    }

    .error {
      background: #fee;
      border: 2px solid #fcc;
      color: #c33;
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
    }

    .error h3 {
      margin-bottom: 10px;
    }

    @media (max-width: 600px) {
      #gallery {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 12px;
      }

      h1 {
        font-size: 22px;
      }

      .stats {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ¬ WebP å‹•ç•«åœ–åº«</h1>
    <p class="subtitle">è¡Œå‹•ç«¯æ¥µè‡´æ•ˆèƒ½ - é›¶ä¾è³´ Vanilla JS æ–¹æ¡ˆ</p>
    <div class="stats">
      <div class="stat" id="stat-count">è¼‰å…¥ä¸­...</div>
      <div class="stat" id="stat-size">è¼‰å…¥ä¸­...</div>
      <div class="stat" id="stat-active">ç•¶å‰æ’­æ”¾: ç„¡</div>
    </div>
  </header>

  <div class="instructions">
    <h2>ğŸ’¡ ä½¿ç”¨èªªæ˜</h2>
    <ul>
      <li>ğŸ“± <strong>é»æ“Šåœ–ç‰‡</strong>å³å¯æ’­æ”¾ WebP å‹•ç•«</li>
      <li>ğŸ”„ <strong>å†æ¬¡é»æ“Š</strong>å¯åœæ­¢æ’­æ”¾ä¸¦æ¢å¾©ç¸®åœ–</li>
      <li>âš¡ ç³»çµ±<strong>åŒæ™‚åªå…è¨±ä¸€å€‹å‹•ç•«æ’­æ”¾</strong>ï¼Œç¢ºä¿æœ€ä½³æ•ˆèƒ½</li>
      <li>ğŸ” å‹•ç•«<strong>é›¢é–‹è¦–çª—</strong>æ™‚æœƒè‡ªå‹•åœæ­¢ä¸¦é‡‹æ”¾è¨˜æ†¶é«”</li>
      <li>ğŸ“Š å»ºç½®å‰è«‹å…ˆå°‡ WebP æª”æ¡ˆæ”¾å…¥ <code>assets/</code> ç›®éŒ„ï¼ŒåŸ·è¡Œ <code>npm run build</code></li>
    </ul>
  </div>

  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
    <p>æ­£åœ¨è¼‰å…¥è³‡æ–™åº«...</p>
  </div>

  <div id="gallery"></div>

  <script type="module">
    import { GalleryEngine } from './src/GalleryEngine.js';

    const galleryContainer = document.getElementById('gallery');
    const loadingEl = document.getElementById('loading');
    const statCount = document.getElementById('stat-count');
    const statSize = document.getElementById('stat-size');
    const statActive = document.getElementById('stat-active');

    // åˆå§‹åŒ–å¼•æ“
    const engine = new GalleryEngine(galleryContainer);

    // è¼‰å…¥ .bin æª”æ¡ˆ
    async function init() {
      try {
        const indexMap = await engine.load('./dist/data.bin');
        
        // éš±è—è¼‰å…¥ç•«é¢
        loadingEl.style.display = 'none';
        
        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        const ids = engine.getAllIds();
        statCount.textContent = `å…± ${ids.length} å€‹å‹•ç•«`;
        statSize.textContent = `å¤§å°: ${(engine.buffer.byteLength / 1024 / 1024).toFixed(2)} MB`;
        
        // æ¸²æŸ“åœ–åº«
        renderGallery(ids);
        
        // ç›£è½å‹•ç•«ç‹€æ…‹è®ŠåŒ–
        observeActiveState();
        
      } catch (error) {
        loadingEl.innerHTML = `
          <div class="error">
            <h3>âŒ è¼‰å…¥å¤±æ•—</h3>
            <p>${error.message}</p>
            <p style="margin-top: 10px;">è«‹ç¢ºèªï¼š</p>
            <ol style="text-align: left; padding-left: 20px; margin-top: 8px;">
              <li>assets/ ç›®éŒ„ä¸­å·²æ”¾ç½® WebP æª”æ¡ˆ</li>
              <li>å·²åŸ·è¡Œ <code>npm install</code></li>
              <li>å·²åŸ·è¡Œ <code>npm run build</code> ç”¢ç”Ÿ dist/data.bin</li>
              <li>ä½¿ç”¨ <code>npm run dev</code> å•Ÿå‹•æœ¬åœ°ä¼ºæœå™¨</li>
            </ol>
          </div>
        `;
      }
    }

    // æ¸²æŸ“åœ–åº«
    function renderGallery(ids) {
      const fragment = document.createDocumentFragment();
      
      ids.forEach(id => {
        const data = engine.getItemData(id);
        if (!data) return;
        
        const item = document.createElement('div');
        item.className = 'gallery-item';
        
        const img = document.createElement('img');
        img.src = data.url;
        img.alt = id;
        img.dataset.id = id;
        img.loading = 'lazy';
        
        const label = document.createElement('div');
        label.className = 'label';
        label.textContent = `${id}\n${data.width}Ã—${data.height}`;
        
        item.appendChild(img);
        item.appendChild(label);
        fragment.appendChild(item);
      });
      
      galleryContainer.appendChild(fragment);
    }

    // ç›£è½å‹•ç•«ç‹€æ…‹è®ŠåŒ–
    function observeActiveState() {
      let lastActiveId = null;
      
      setInterval(() => {
        const currentId = engine.activeState.id;
        if (currentId !== lastActiveId) {
          statActive.textContent = currentId 
            ? `ç•¶å‰æ’­æ”¾: ${currentId}` 
            : 'ç•¶å‰æ’­æ”¾: ç„¡';
          lastActiveId = currentId;
        }
      }, 100);
    }

    // å•Ÿå‹•
    init();

    // é é¢å¸è¼‰æ™‚æ¸…ç†è³‡æº
    window.addEventListener('beforeunload', () => {
      engine.dispose();
    });
  </script>
</body>
</html>
