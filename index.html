<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#37383C">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <title>aiG</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #37383C;
      padding: 20px;
      line-height: 1.6;
      padding-bottom: 80px;
      min-height: 100vh;
    }

    .upload-section {
      padding: 40px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-block;
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    .upload-btn {
      display: inline-block;
      padding: 15px 40px;
      /* background: rgba(255, 255, 255, 0.1); */
      color: white;
      border-radius: 5px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .upload-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
    }

    .upload-btn:active {
      transform: translateY(0);
    }

    .destroy-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 24px;
      background: rgba(255, 100, 100, 0.2);
      color: #ff6b6b;
      border: 2px solid rgba(255, 100, 100, 0.4);
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 1000;
      display: none;
      backdrop-filter: blur(10px);
    }

    .destroy-btn:hover {
      background: rgba(255, 100, 100, 0.3);
      transform: scale(1.05);
    }

    .destroy-btn:active {
      transform: scale(0.95);
    }

    .destroy-btn.visible {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 5px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: none;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      margin: 0 auto 20px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top: 4px solid rgba(255, 255, 255, 0.4);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    #gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .gallery-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 5px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
      position: relative;
      animation: fadeIn 0.5s ease-out backwards;
      cursor: pointer;
      min-height: 150px;
    }

    .gallery-item.placeholder {
      background: rgba(255, 255, 255, 0.02);
    }

    .gallery-item:nth-child(1) { animation-delay: 0.05s; }
    .gallery-item:nth-child(2) { animation-delay: 0.1s; }
    .gallery-item:nth-child(3) { animation-delay: 0.15s; }
    .gallery-item:nth-child(4) { animation-delay: 0.2s; }
    .gallery-item:nth-child(5) { animation-delay: 0.25s; }
    .gallery-item:nth-child(6) { animation-delay: 0.3s; }
    .gallery-item:nth-child(7) { animation-delay: 0.35s; }
    .gallery-item:nth-child(8) { animation-delay: 0.4s; }

    .gallery-item:hover {
      transform: translateY(-4px);
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    .gallery-item img {
      width: 100%;
      height: auto;
      display: block;
      -webkit-user-select: none;
      user-select: none;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .gallery-item:hover img {
      transform: scale(1.05);
    }

    .fullscreen-icon {
      position: absolute;
      bottom: 12px;
      right: 12px;
      width: 40px;
      height: 40px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 10;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .fullscreen-icon:hover {
      background: rgba(0, 0, 0, 0.8);
      transform: scale(1.1);
      border-color: rgba(255, 255, 255, 0.4);
    }

    .fullscreen-icon svg {
      width: 20px;
      height: 20px;
      fill: white;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease-out;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      animation: scaleIn 0.4s ease-out;
    }

    .modal-content img {
      max-width: 100%;
      max-height: 90vh;
      object-fit: contain;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      color: white;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      z-index: 10000;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(90deg);
    }

    .error {
      background: rgba(255, 100, 100, 0.1);
      border: 2px solid rgba(255, 100, 100, 0.3);
      color: #ff6b6b;
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
    }

    @media (max-width: 600px) {
      body {
        padding: 10px;
        padding-bottom: 60px;
      }

      #gallery {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 12px;
      }

      .modal-content img {
        max-height: 90vh;
      }

      .modal-close {
        top: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <button class="destroy-btn" id="destroy-btn">üóëÔ∏è Èä∑ÊØÄË≥áÊ∫ê</button>
  
  <div class="upload-section" id="upload-section">
    <div class="file-input-wrapper">
      <input type="file" id="file-input" accept=".bin">
      <label for="file-input" class="upload-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
	<path fill="currentColor" d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8zm4 18H6V4h7v5h5z" />
</svg>
      </label>
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
  </div>

  <div id="gallery"></div>

  <div class="modal" id="modal">
    <div class="modal-close" id="modal-close">√ó</div>
    <div class="modal-content">
      <img id="modal-img" src="" alt="">
    </div>
  </div>

  <script>
    // ==================== GalleryEngine Ê†∏ÂøÉÂºïÊìé ====================
    class GalleryEngine {
      constructor(containerElement) {
        this.container = containerElement;
        this.buffer = null;
        this.indexMap = null;
        this.payloadStart = 0;

        // ÁãÄÊÖãÁÆ°ÁêÜ
        this.thumbUrls = new Map(); 
        this.activeState = { 
          id: null, 
          imgEl: null, 
          animUrl: null 
        };

        // Virtual Scroller ÁãÄÊÖã
        this.allIds = [];
        this.renderedItems = new Map(); // id -> {element, isLoaded}
        this.loadedThumbs = new Set(); // Â∑≤Âä†ËºâÁöÑÁ∏ÆÂúñ ID

        // Èõ¢ÈñãË¶ñÁ™óËá™ÂãïÂõûÊî∂Ê©üÂà∂ (Èò≤ iOS Â¥©ÊΩ∞Ê†∏ÂøÉ)
        this.animationObserver = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (!entry.isIntersecting && entry.target === this.activeState.imgEl) {
              this.stopActiveAnimation();
            }
          });
        }, { threshold: 0 });

        // Virtual Scroller ËßÄÂØüÂô® - ÁÆ°ÁêÜÊâÄÊúâÂúñÁâáÁöÑÂä†ËºâËàáÂç∏Ëºâ
        this.virtualObserver = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            const id = entry.target.dataset.id;
            if (!id) return;

            if (entry.isIntersecting) {
              // ÈÄ≤ÂÖ•Ë¶ñÁ™ó - Âä†ËºâÁ∏ÆÂúñ
              this.loadThumbnail(id, entry.target);
            } else {
              // Èõ¢ÈñãË¶ñÁ™ó - Âç∏ËºâÂúñÁâáÔºà‰ΩÜ‰øùÁïô DOM ÁµêÊßãÔºâ
              this.unloadThumbnail(id, entry.target);
            }
          });
        }, { 
          rootMargin: '200px', // ÊèêÂâç 200px ÈñãÂßãÂä†Ëºâ
          threshold: 0 
        });

        // Á∂ÅÂÆö‰∫ã‰ª∂‰ª£ÁêÜ (Fast Click)
        this.handleTap = this.handleTap.bind(this);
        this.container.addEventListener('click', this.handleTap);
      }

      async loadFromFile(file) {
        console.log('üîÑ Ê≠£Âú®ËºâÂÖ•Ë≥áÊñôÂ∫´...');
        
        try {
          this.buffer = await file.arrayBuffer();
          const dataView = new DataView(this.buffer);
          
          // ËÆÄÂèñ Header (4 bytes)ÔºöJSON Á¥¢ÂºïÈï∑Â∫¶
          const headerLen = dataView.getUint32(0, true);
          
          // Ëß£Êûê JSON Á¥¢Âºï
          const jsonStr = new TextDecoder().decode(
            new Uint8Array(this.buffer, 4, headerLen)
          );
          this.indexMap = JSON.parse(jsonStr);
          
          // Ë®àÁÆó Payload Ëµ∑Âßã‰ΩçÁΩÆ
          this.payloadStart = 4 + headerLen;

          console.log(`‚úÖ ËºâÂÖ•ÂÆåÊàêÔºöÂÖ± ${Object.keys(this.indexMap).length} ÂÄãÈ†ÖÁõÆ`);
          console.log(`   Ë≥áÊñôÂ§ßÂ∞èÔºö${(this.buffer.byteLength / 1024 / 1024).toFixed(2)} MB`);

          // ÂàùÂßãÂåñÊâÄÊúâÁ∏ÆÂúñ
          this.initThumbnails();
          
          return this.indexMap;
        } catch (error) {
          console.error('‚ùå ËºâÂÖ•Â§±Êïó:', error);
          throw error;
        }
      }

      initThumbnails() {
        console.log('üñºÔ∏è  Ê∫ñÂÇô Virtual Scroller (Âª∂ÈÅ≤Âä†ËºâÊ®°Âºè)...');
        this.allIds = Object.keys(this.indexMap);
        console.log(`‚úÖ Ê∫ñÂÇôÂÆåÊàêÔºöÂÖ± ${this.allIds.length} ÂÄãÈ†ÖÁõÆÔºàÂÉÖÂèØË¶ñÁØÑÂúçÊúÉÂä†ËºâÔºâ`);
      }

      loadThumbnail(id, itemElement) {
        if (this.loadedThumbs.has(id)) return; // Â∑≤Âä†Ëºâ
        
        const meta = this.indexMap[id];
        if (!meta) return;

        const slice = this.buffer.slice(
          this.payloadStart + meta.thumb.offset, 
          this.payloadStart + meta.thumb.offset + meta.thumb.length
        );
        const thumbUrl = URL.createObjectURL(new Blob([slice], { type: 'image/webp' }));
        this.thumbUrls.set(id, thumbUrl);
        this.loadedThumbs.add(id);

        // Êõ¥Êñ∞ DOM
        const img = itemElement.querySelector('img');
        if (img) {
          img.src = thumbUrl;
          itemElement.classList.remove('placeholder');
          console.log(`‚úÖ Âä†ËºâÁ∏ÆÂúñ: ${id}`);
        }
      }

      unloadThumbnail(id, itemElement) {
        if (!this.loadedThumbs.has(id)) return; // Êú™Âä†Ëºâ
        
        // Â¶ÇÊûúÊ≠£Âú®Êí≠ÊîæÂãïÁï´Ôºå‰∏çË¶ÅÂç∏Ëºâ
        if (this.activeState.id === id) return;

        const thumbUrl = this.thumbUrls.get(id);
        if (thumbUrl) {
          URL.revokeObjectURL(thumbUrl);
          this.thumbUrls.delete(id);
        }
        this.loadedThumbs.delete(id);

        // ÁßªÈô§ÂúñÁâá‰ΩÜ‰øùÁïô‰Ωî‰ΩçÁ¨¶
        const img = itemElement.querySelector('img');
        if (img) {
          img.src = '';
          itemElement.classList.add('placeholder');
          console.log(`üóëÔ∏è  Âç∏ËºâÁ∏ÆÂúñ: ${id}`);
        }
      }

      getItemData(id) {
        if (!this.indexMap || !this.indexMap[id]) {
          console.warn(`‚ö†Ô∏è  È†ÖÁõÆ‰∏çÂ≠òÂú®: ${id}`);
          return null;
        }
        
        return {
          url: this.thumbUrls.get(id),
          width: this.indexMap[id].width,
          height: this.indexMap[id].height
        };
      }

      getAllIds() {
        return this.indexMap ? Object.keys(this.indexMap) : [];
      }

      handleTap(e) {
        const target = e.target;
        if (target.tagName !== 'IMG' || !target.dataset.id) return;
        
        const id = target.dataset.id;

        // ÈªûÊìäÂêå‰∏ÄÂÄãÊ≠£Âú®Êí≠ÊîæÁöÑ -> ÂÅúÊ≠¢
        if (this.activeState.id === id) {
          console.log(`‚èπÔ∏è  ÂÅúÊ≠¢ÂãïÁï´: ${id}`);
          this.stopActiveAnimation();
          return;
        }

        // ÈªûÊìäÊñ∞ÁöÑ -> ÂÖàÂÅúÊ≠¢ËàäÁöÑÔºåÂÜçÊí≠Êñ∞ÁöÑ
        if (this.activeState.id) {
          console.log(`‚èπÔ∏è  ÂÅúÊ≠¢Ââç‰∏ÄÂÄãÂãïÁï´: ${this.activeState.id}`);
          this.stopActiveAnimation();
        }

        // JIT Âª∫Á´ãÂãïÁï´ Blob
        console.log(`‚ñ∂Ô∏è  Êí≠ÊîæÂãïÁï´: ${id}`);
        this.playAnimation(id, target);
      }

      playAnimation(id, imgEl) {
        const meta = this.indexMap[id];
        if (!meta) {
          console.warn(`‚ö†Ô∏è  ÂãïÁï´‰∏çÂ≠òÂú®: ${id}`);
          return;
        }

        // Âæû ArrayBuffer ÂàáÂâ≤ÂãïÁï´Ë≥áÊñô (Zero-copy)
        const slice = this.buffer.slice(
          this.payloadStart + meta.anim.offset, 
          this.payloadStart + meta.anim.offset + meta.anim.length
        );
        
        // Âª∫Á´ã Blob URL
        const animUrl = URL.createObjectURL(
          new Blob([slice], { type: 'image/webp' })
        );

        // Êõ¥Êñ∞ÁãÄÊÖãËàáÁï´Èù¢
        this.activeState = { id, imgEl, animUrl };
        imgEl.src = animUrl;
        
        // ÈñãÂßãÁõ£ËÅΩÊòØÂê¶Èõ¢ÈñãË¶ñÁ™ó
        this.animationObserver.observe(imgEl);
      }

      stopActiveAnimation() {
        if (!this.activeState.id) return;
        
        // ÂÅúÊ≠¢Áõ£ËÅΩ
        this.animationObserver.unobserve(this.activeState.imgEl);
        
        // ÊÅ¢Âæ©Á∏ÆÂúñ
        const thumbUrl = this.thumbUrls.get(this.activeState.id);
        if (thumbUrl) {
          this.activeState.imgEl.src = thumbUrl;
        }
        
        // ÈáãÊîæÂãïÁï´ Blob URL Ë®òÊÜ∂È´î
        URL.revokeObjectURL(this.activeState.animUrl);
        
        // ÈáçÁΩÆÁãÄÊÖã
        this.activeState = { id: null, imgEl: null, animUrl: null };
      }

      getAnimationUrl(id) {
        const meta = this.indexMap[id];
        if (!meta) return null;

        const slice = this.buffer.slice(
          this.payloadStart + meta.anim.offset, 
          this.payloadStart + meta.anim.offset + meta.anim.length
        );
        
        return URL.createObjectURL(new Blob([slice], { type: 'image/webp' }));
      }

      dispose() {
        console.log('üóëÔ∏è  Ê≠£Âú®Èä∑ÊØÄ GalleryEngine...');
        
        this.stopActiveAnimation();
        this.container.removeEventListener('click', this.handleTap);
        this.animationObserver.disconnect();
        this.virtualObserver.disconnect();
        
        // ÈáãÊîæÊâÄÊúâÁ∏ÆÂúñ URL
        for (const url of this.thumbUrls.values()) {
          URL.revokeObjectURL(url);
        }
        this.thumbUrls.clear();
        this.loadedThumbs.clear();
        this.renderedItems.clear();
        
        // Ê∏ÖÁ©∫Ë≥áÊñô
        this.buffer = null;
        this.indexMap = null;
        this.allIds = [];
        this.container.innerHTML = '';
        
        console.log('‚úÖ Èä∑ÊØÄÂÆåÊàê - ÊâÄÊúâË≥áÊ∫êÂ∑≤ÈáãÊîæ');
      }
    }

    // ==================== ‰∏ªÊáâÁî®Á®ãÂºè ====================
    const galleryContainer = document.getElementById('gallery');
    const uploadSection = document.getElementById('upload-section');
    const loadingEl = document.getElementById('loading');
    const fileInput = document.getElementById('file-input');
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modal-img');
    const modalClose = document.getElementById('modal-close');
    const destroyBtn = document.getElementById('destroy-btn');

    let engine = new GalleryEngine(galleryContainer);
    let currentModalUrl = null;

    // Ê™îÊ°àÈÅ∏Êìá‰∫ã‰ª∂
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      uploadSection.style.display = 'none';
      loadingEl.style.display = 'block';

      try {
        await engine.loadFromFile(file);
        
        loadingEl.style.display = 'none';
        
        // ‰ΩøÁî® console.log Ëº∏Âá∫Áµ±Ë®àË≥áË®ä
        const ids = engine.getAllIds();
        console.log(`‚úÖ ËºâÂÖ•ÂÆåÊàêÔºöÂÖ± ${ids.length} ÂÄãÂãïÁï´`);
        console.log(`üìä Ê™îÊ°àÂ§ßÂ∞èÔºö${(engine.buffer.byteLength / 1024 / 1024).toFixed(2)} MB`);
        
        // Ê∏≤ÊüìÂúñÂ∫´ (Virtual Scroller)
        renderGallery(ids);
        
        // È°ØÁ§∫Èä∑ÊØÄÊåâÈàï
        destroyBtn.classList.add('visible');
        
        // Áõ£ËÅΩÂãïÁï´ÁãÄÊÖãËÆäÂåñ
        observeActiveState();
        
      } catch (error) {
        console.error('‚ùå ËºâÂÖ•Â§±Êïó:', error);
        loadingEl.innerHTML = `
          <div class="error">
            <p>${error.message}</p>
          </div>
        `;
      }
    });

    // Ê∏≤ÊüìÂúñÂ∫´ (Virtual Scroller - Âè™ÂâµÂª∫ DOM È™®Êû∂ÔºåÂª∂ÈÅ≤Âä†ËºâÂúñÁâá)
    function renderGallery(ids) {
      const fragment = document.createDocumentFragment();
      
      ids.forEach(id => {
        const item = document.createElement('div');
        item.className = 'gallery-item placeholder';
        item.dataset.id = id;
        
        const img = document.createElement('img');
        img.alt = id;
        img.dataset.id = id;
        // ‰∏çË®≠ÁΩÆ src - Á≠âÂæÖ IntersectionObserver Ëß∏ÁôºÂä†Ëºâ
        
        // Âè≥‰∏ãËßíÂÖ®Â±èÂúñÊ®ô
        const fullscreenIcon = document.createElement('div');
        fullscreenIcon.className = 'fullscreen-icon';
        fullscreenIcon.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
          </svg>
        `;
        fullscreenIcon.onclick = (e) => {
          e.stopPropagation();
          openModal(id);
        };
        
        item.appendChild(img);
        item.appendChild(fullscreenIcon);
        fragment.appendChild(item);
        
        // ÈñãÂßãÁõ£ËÅΩÈÄôÂÄãÈ†ÖÁõÆ
        engine.virtualObserver.observe(item);
        engine.renderedItems.set(id, { element: item, isLoaded: false });
      });
      
      galleryContainer.appendChild(fragment);
      console.log(`üì¶ Virtual Scroller: Â∑≤ÂâµÂª∫ ${ids.length} ÂÄã DOM ÂÆπÂô® (ÂúñÁâáÊåâÈúÄÂä†Ëºâ)`);
    }

    // ÈñãÂïüÂÖ®Ëû¢ÂπïÊ®°ÊÖãÊ°Ü
    function openModal(id) {
      const data = engine.getItemData(id);
      if (!data) return;

      // ÂÅúÊ≠¢Áï∂ÂâçÊí≠ÊîæÁöÑÂãïÁï´
      engine.stopActiveAnimation();

      // ÂèñÂæóÂãïÁï´ URL
      currentModalUrl = engine.getAnimationUrl(id);
      
      modalImg.src = currentModalUrl;
      modal.classList.add('active');
      
      console.log(`‚ñ∂Ô∏è Êí≠ÊîæÔºö${id} (${data.width} √ó ${data.height})`);
      
      // Èò≤Ê≠¢ËÉåÊôØÊªæÂãï
      document.body.style.overflow = 'hidden';
    }

    // ÈóúÈñâÊ®°ÊÖãÊ°Ü
    function closeModal() {
      modal.classList.remove('active');
      document.body.style.overflow = '';
      
      // ÈáãÊîæÂãïÁï´ URL
      if (currentModalUrl) {
        URL.revokeObjectURL(currentModalUrl);
        currentModalUrl = null;
      }
      
      modalImg.src = '';
      console.log('‚èπÔ∏è ÂÅúÊ≠¢Êí≠Êîæ');
    }

    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });

    // ESC ÈçµÈóúÈñâ
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.classList.contains('active')) {
        closeModal();
      }
    });

    // Èä∑ÊØÄÊåâÈàï‰∫ã‰ª∂
    destroyBtn.addEventListener('click', () => {
      if (confirm('Á¢∫ÂÆöË¶ÅÈä∑ÊØÄÊâÄÊúâË≥áÊ∫êÂóéÔºüÊ≠§Êìç‰ΩúÂ∞áÊ∏ÖÁ©∫ÊâÄÊúâÊï∏Êìö‰∏¶ÈáãÊîæË®òÊÜ∂È´î„ÄÇ')) {
        closeModal();
        engine.dispose();
        engine = new GalleryEngine(galleryContainer);
        
        destroyBtn.classList.remove('visible');
        uploadSection.style.display = 'block';
        
        console.log('‚ôªÔ∏è  Âº∑Âà∂ GC: ÊâÄÊúâË≥áÊ∫êÂ∑≤ÈáãÊîæÔºåÁ≠âÂæÖÁÄèË¶ΩÂô®ÂûÉÂúæÂõûÊî∂...');
      }
    });

    // Áõ£ËÅΩÂãïÁï´ÁãÄÊÖãËÆäÂåñ
    function observeActiveState() {
      let lastActiveId = null;
      
      setInterval(() => {
        const currentId = engine.activeState.id;
        if (currentId !== lastActiveId) {
          if (currentId) {
            console.log(`üé¨ Áï∂ÂâçÊí≠ÊîæÔºö${currentId}`);
          } else {
            console.log('‚è∏Ô∏è ÁÑ°Êí≠Êîæ‰∏≠ÁöÑÂãïÁï´');
          }
          lastActiveId = currentId;
        }
      }, 100);
    }

    // È†ÅÈù¢Âç∏ËºâÊôÇÊ∏ÖÁêÜË≥áÊ∫ê
    window.addEventListener('beforeunload', () => {
      engine.dispose();
      if (currentModalUrl) {
        URL.revokeObjectURL(currentModalUrl);
      }
    });

    // ==================== PWA ÊîØÊè¥ ====================
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('‚úÖ Service Worker Ë®ªÂÜäÊàêÂäü', reg))
          .catch(err => console.log('‚ùå Service Worker Ë®ªÂÜäÂ§±Êïó', err));
      });
    }
  </script>
</body>
</html>
