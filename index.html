<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="theme-color" content="#37383C" />
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="icon-192.png" />
    <title>aiG</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #37383c;
        padding: 20px;
        line-height: 1.6;
        padding-bottom: 80px;
        min-height: 100vh;
      }

      .upload-section {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }

      .file-input-wrapper {
        position: relative;
        display: inline-block;
      }

      .file-input-wrapper input[type="file"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
      }

      .upload-btn {
        display: inline-block;
        padding: 8px 24px;
        background: #4a4b50;
        color: white;
        border-radius: 5px;
        font-size: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .upload-btn:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-2px);
      }

      .upload-btn:active {
        transform: translateY(0);
      }

      .destroy-btn {
        position: fixed;
        top: 10px;
        left: 5px;
        padding: 5px 24px;
        background: #4a4b50;
        color: #fff;
        border: none;
        border-radius: 2px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 1000;
        display: none;
        backdrop-filter: blur(10px);
      }

      .destroy-btn:hover {
        background: rgba(255, 100, 100, 0.3);
        transform: scale(1.05);
      }

      .destroy-btn:active {
        transform: scale(0.95);
      }

      .destroy-btn.visible {
        display: block;
        animation: fadeIn 0.3s ease-out;
      }

      .loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        align-items: center;
        justify-content: center;
        z-index: 100;
        display: flex;
        cursor: pointer;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        margin: 0 auto 20px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-top: 4px solid rgba(255, 255, 255, 0.4);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes scaleIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      #gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 5px;
        margin-top: 50px;
      }

      .gallery-item {
        border-radius: 3px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
        position: relative;
        animation: fadeIn 0.5s ease-out backwards;
        cursor: pointer;
        min-height: 150px;
        touch-action: manipulation; /* ç¦ç”¨é›™æ“Šç¸®æ”¾ï¼ŒåŠ é€Ÿé›™æ“ŠéŸ¿æ‡‰ */
      }

      .gallery-item.placeholder {
        background: rgba(255, 255, 255, 0.02);
      }

      .gallery-item:nth-child(1) {
        animation-delay: 0.05s;
      }
      .gallery-item:nth-child(2) {
        animation-delay: 0.1s;
      }
      .gallery-item:nth-child(3) {
        animation-delay: 0.15s;
      }
      .gallery-item:nth-child(4) {
        animation-delay: 0.2s;
      }
      .gallery-item:nth-child(5) {
        animation-delay: 0.25s;
      }
      .gallery-item:nth-child(6) {
        animation-delay: 0.3s;
      }
      .gallery-item:nth-child(7) {
        animation-delay: 0.35s;
      }
      .gallery-item:nth-child(8) {
        animation-delay: 0.4s;
      }

      .gallery-item:hover {
        transform: translateY(-4px);
        border-color: rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      }

      .gallery-item img,
      .gallery-item video {
        width: 100%;
        height: auto;
        display: block;
        -webkit-user-select: none;
        user-select: none;
        cursor: pointer;
        transition: transform 0.3s ease;
        touch-action: manipulation; /* ç¦ç”¨é›™æ“Šç¸®æ”¾ï¼ŒåŠ é€Ÿé›™æ“ŠéŸ¿æ‡‰ */
      }

      .gallery-item video {
        display: none;
      }

      .gallery-item:hover img,
      .gallery-item:hover video {
        transform: scale(1.05);
      }

      .fullscreen-icon {
        position: absolute;
        bottom: 5px;
        right: 5px;
        width: 30px;
        height: 30px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 10;
        backdrop-filter: blur(10px);
      }

      .fullscreen-icon:hover {
        background: rgba(0, 0, 0, 0.8);
        transform: scale(1.1);
        border-color: rgba(255, 255, 255, 0.4);
      }

      .fullscreen-icon svg {
        width: 20px;
        height: 20px;
        fill: white;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease-out;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        position: relative;
        max-width: 90vw;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        animation: scaleIn 0.4s ease-out;
      }

      .modal-content img {
        max-width: 100%;
        max-height: 90vh;
        object-fit: contain;
      }

      .modal-close {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        color: white;
        font-size: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        z-index: 10000;
      }

      .modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
      }

      .error {
        background: rgba(255, 100, 100, 0.1);
        border: 2px solid rgba(255, 100, 100, 0.3);
        color: #ff6b6b;
        padding: 20px;
        border-radius: 12px;
        margin-top: 20px;
      }

      @media (max-width: 600px) {
        body {
          padding: 5px;
          padding-bottom: 60px;
        }

        #gallery {
          grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
          gap: 5px;
        }

        .modal-content img {
          max-height: 90vh;
        }

        .modal-close {
          top: 10px;
          right: 10px;
          width: 40px;
          height: 40px;
          font-size: 20px;
        }
      }
    </style>
  </head>
  <body>
    <button class="destroy-btn" id="destroy-btn">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="16"
        height="16"
        viewBox="0 0 16 16"
      >
        <path
          fill="currentColor"
          fill-rule="evenodd"
          d="M5.75 3V1.5h4.5V3zm-1.5 0V1a1 1 0 0 1 1-1h5.5a1 1 0 0 1 1 1v2h2.5a.75.75 0 0 1 0 1.5h-.365l-.743 9.653A2 2 0 0 1 11.148 16H4.852a2 2 0 0 1-1.994-1.847L2.115 4.5H1.75a.75.75 0 0 1 0-1.5zm-.63 1.5h8.76l-.734 9.538a.5.5 0 0 1-.498.462H4.852a.5.5 0 0 1-.498-.462z"
          clip-rule="evenodd"
        />
      </svg>
    </button>

    <div class="upload-section" id="upload-section">
      <div class="file-input-wrapper">
        <input type="file" id="file-input" accept=".bin" />
        <label for="file-input" class="upload-btn">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
          >
            <path
              fill="currentColor"
              d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8zm4 18H6V4h7v5h5z"
            />
          </svg>
        </label>
      </div>
    </div>

    <div class="loading" id="loading">
      <div class="loading-spinner"></div>
    </div>

    <div id="gallery"></div>

    <div class="modal" id="modal">
      <div class="modal-close" id="modal-close">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
        >
          <g
            fill="none"
            stroke="currentColor"
            stroke-dasharray="22"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="1"
          >
            <path d="M5 5l14 14">
              <animate
                fill="freeze"
                attributeName="stroke-dashoffset"
                dur="0.5s"
                values="22;0"
              />
            </path>
            <path stroke-dashoffset="22" d="M19 5l-14 14">
              <animate
                fill="freeze"
                attributeName="stroke-dashoffset"
                begin="0.5s"
                dur="0.5s"
                to="0"
              />
            </path>
          </g>
        </svg>
      </div>
      <div class="modal-content">
        <img id="modal-img" src="" alt="" style="display: none;" />
        <video id="modal-video" src="" loop autoplay muted playsinline style="display: none; max-width: 100%; max-height: 90vh;"></video>
      </div>
    </div>

    <script>
      // ==================== GalleryEngine æ ¸å¿ƒå¼•æ“ ====================
      class GalleryEngine {
        constructor(containerElement) {
          this.container = containerElement;
          this.buffer = null;
          this.indexMap = null;
          this.payloadStart = 0;

          // ç‹€æ…‹ç®¡ç†
          this.thumbUrls = new Map();
          this.activeState = {
            id: null,
            element: null,
            animUrl: null,
            type: null,
          };

          // é»æ“Šå»¶è¿Ÿè¨ˆæ™‚å™¨ï¼ˆé˜²æ­¢å–®æ“Šå’Œé›™æ“Šè¡çªï¼‰
          this.clickTimer = null;
          this.clickDelay = 250; // 250ms å»¶é²

          // ç§»å‹•è¨­å‚™é›™æ“Šæª¢æ¸¬
          this.lastTapTime = 0;
          this.lastTapTarget = null;
          this.doubleTapDelay = 300; // 300ms å…§è¦–ç‚ºé›™æ“Š
          this.justDoubleTapped = false; // æ¨™è¨˜æ˜¯å¦å‰›å‰›é›™æ“Šï¼ˆé˜²æ­¢è§¸ç™¼å–®æ“Šï¼‰

          // Virtual Scroller ç‹€æ…‹
          this.allIds = [];
          this.renderedItems = new Map(); // id -> {element, isLoaded}
          this.loadedThumbs = new Set(); // å·²åŠ è¼‰çš„ç¸®åœ– ID

          // é›¢é–‹è¦–çª—è‡ªå‹•å›æ”¶æ©Ÿåˆ¶ (é˜² iOS å´©æ½°æ ¸å¿ƒ)
          this.animationObserver = new IntersectionObserver(
            (entries) => {
              entries.forEach((entry) => {
                if (
                  !entry.isIntersecting &&
                  entry.target === this.activeState.imgEl
                ) {
                  this.stopActiveAnimation();
                }
              });
            },
            { threshold: 0 },
          );

          // Virtual Scroller è§€å¯Ÿå™¨ - ç®¡ç†æ‰€æœ‰åœ–ç‰‡çš„åŠ è¼‰èˆ‡å¸è¼‰
          this.virtualObserver = new IntersectionObserver(
            (entries) => {
              entries.forEach((entry) => {
                const id = entry.target.dataset.id;
                if (!id) return;

                if (entry.isIntersecting) {
                  // é€²å…¥è¦–çª— - åŠ è¼‰ç¸®åœ–
                  this.loadThumbnail(id, entry.target);
                } else {
                  // é›¢é–‹è¦–çª— - å¸è¼‰åœ–ç‰‡ï¼ˆä½†ä¿ç•™ DOM çµæ§‹ï¼‰
                  this.unloadThumbnail(id, entry.target);
                }
              });
            },
            {
              rootMargin: "200px", // æå‰ 200px é–‹å§‹åŠ è¼‰
              threshold: 0,
            },
          );

          // ç¶å®šäº‹ä»¶ä»£ç†
          this.handleTap = this.handleTap.bind(this);
          this.handleDoubleTap = this.handleDoubleTap.bind(this);
          this.handleTouchEnd = this.handleTouchEnd.bind(this);
          
          this.container.addEventListener("click", this.handleTap);
          this.container.addEventListener("dblclick", this.handleDoubleTap);
          this.container.addEventListener("touchend", this.handleTouchEnd);
        }

        async loadFromFile(file) {
          console.log("ğŸ”„ æ­£åœ¨è¼‰å…¥è³‡æ–™åº«...");

          try {
            this.buffer = await file.arrayBuffer();
            const dataView = new DataView(this.buffer);

            // è®€å– Header (4 bytes)ï¼šJSON ç´¢å¼•é•·åº¦
            const headerLen = dataView.getUint32(0, true);

            // è§£æ JSON ç´¢å¼•
            const jsonStr = new TextDecoder().decode(
              new Uint8Array(this.buffer, 4, headerLen),
            );
            this.indexMap = JSON.parse(jsonStr);

            // è¨ˆç®— Payload èµ·å§‹ä½ç½®
            this.payloadStart = 4 + headerLen;

            console.log(
              `âœ… è¼‰å…¥å®Œæˆï¼šå…± ${Object.keys(this.indexMap).length} å€‹é …ç›®`,
            );
            console.log(
              `   è³‡æ–™å¤§å°ï¼š${(this.buffer.byteLength / 1024 / 1024).toFixed(2)} MB`,
            );

            // åˆå§‹åŒ–æ‰€æœ‰ç¸®åœ–
            this.initThumbnails();

            return this.indexMap;
          } catch (error) {
            console.error("âŒ è¼‰å…¥å¤±æ•—:", error);
            throw error;
          }
        }

        initThumbnails() {
          console.log("ğŸ–¼ï¸  æº–å‚™ Virtual Scroller (å»¶é²åŠ è¼‰æ¨¡å¼)...");
          this.allIds = Object.keys(this.indexMap);
          console.log(
            `âœ… æº–å‚™å®Œæˆï¼šå…± ${this.allIds.length} å€‹é …ç›®ï¼ˆåƒ…å¯è¦–ç¯„åœæœƒåŠ è¼‰ï¼‰`,
          );
        }

        loadThumbnail(id, itemElement) {
          if (this.loadedThumbs.has(id)) return; // å·²åŠ è¼‰

          const meta = this.indexMap[id];
          if (!meta) return;

          const slice = this.buffer.slice(
            this.payloadStart + meta.thumb.offset,
            this.payloadStart + meta.thumb.offset + meta.thumb.length,
          );
          const thumbUrl = URL.createObjectURL(
            new Blob([slice], { type: "image/webp" }),
          );
          this.thumbUrls.set(id, thumbUrl);
          this.loadedThumbs.add(id);

          // æ›´æ–° DOM
          const img = itemElement.querySelector("img");
          if (img) {
            img.src = thumbUrl;
            itemElement.classList.remove("placeholder");
            console.log(`âœ… åŠ è¼‰ç¸®åœ–: ${id}`);
          }
        }

        unloadThumbnail(id, itemElement) {
          if (!this.loadedThumbs.has(id)) return; // æœªåŠ è¼‰

          // å¦‚æœæ­£åœ¨æ’­æ”¾å‹•ç•«ï¼Œä¸è¦å¸è¼‰
          if (this.activeState.id === id) return;

          const thumbUrl = this.thumbUrls.get(id);
          if (thumbUrl) {
            URL.revokeObjectURL(thumbUrl);
            this.thumbUrls.delete(id);
          }
          this.loadedThumbs.delete(id);

          // ç§»é™¤åœ–ç‰‡ä½†ä¿ç•™ä½”ä½ç¬¦
          const img = itemElement.querySelector("img");
          if (img) {
            img.src = "";
            itemElement.classList.add("placeholder");
            console.log(`ğŸ—‘ï¸  å¸è¼‰ç¸®åœ–: ${id}`);
          }
        }

        getItemData(id) {
          if (!this.indexMap || !this.indexMap[id]) {
            console.warn(`âš ï¸  é …ç›®ä¸å­˜åœ¨: ${id}`);
            return null;
          }

          return {
            url: this.thumbUrls.get(id),
            width: this.indexMap[id].width,
            height: this.indexMap[id].height,
            type: this.indexMap[id].type || 'webp', // å‘ä¸‹ç›¸å®¹èˆŠç‰ˆ .bin æª”
          };
        }

        getAllIds() {
          return this.indexMap ? Object.keys(this.indexMap) : [];
        }

        handleTap(e) {
          const target = e.target;
          if ((target.tagName !== "IMG" && target.tagName !== "VIDEO") || !target.dataset.id) return;

          // å¦‚æœå‰›å‰›è§¸ç™¼äº†ç§»å‹•é›™æ“Šï¼Œå¿½ç•¥é€™æ¬¡å–®æ“Š
          if (this.justDoubleTapped) {
            this.justDoubleTapped = false;
            return;
          }

          const id = target.dataset.id;

          // æ¸…é™¤ä¹‹å‰çš„å–®æ“Šè¨ˆæ™‚å™¨
          if (this.clickTimer) {
            clearTimeout(this.clickTimer);
            this.clickTimer = null;
          }

          // å»¶é²åŸ·è¡Œå–®æ“Šæ“ä½œï¼ˆçµ¦é›™æ“Šæ©Ÿæœƒï¼‰
          this.clickTimer = setTimeout(() => {
            this.clickTimer = null;
            this.justDoubleTapped = false; // é‡ç½®æ¨™èªŒ
            
            // é»æ“ŠåŒä¸€å€‹æ­£åœ¨æ’­æ”¾çš„ -> åœæ­¢
            if (this.activeState.id === id) {
              console.log(`â¹ï¸  åœæ­¢å‹•ç•«: ${id}`);
              this.stopActiveAnimation();
              return;
            }

            // é»æ“Šæ–°çš„ -> å…ˆåœæ­¢èˆŠçš„ï¼Œå†æ’­æ–°çš„
            if (this.activeState.id) {
              console.log(`â¹ï¸  åœæ­¢å‰ä¸€å€‹å‹•ç•«: ${this.activeState.id}`);
              this.stopActiveAnimation();
            }

            // JIT å»ºç«‹å‹•ç•« Blob
            console.log(`â–¶ï¸  æ’­æ”¾å‹•ç•«: ${id}`);
            this.playAnimation(id, target);
          }, this.clickDelay);
        }

        handleDoubleTap(e) {
          const target = e.target;
          if ((target.tagName !== "IMG" && target.tagName !== "VIDEO") || !target.dataset.id) return;

          // é˜»æ­¢å–®æ“Šäº‹ä»¶åŸ·è¡Œ
          if (this.clickTimer) {
            clearTimeout(this.clickTimer);
            this.clickTimer = null;
          }

          const id = target.dataset.id;
          console.log(`ğŸ–¼ï¸  é›™æ“Šå…¨è¢å¹•: ${id}`);

          // åœæ­¢ç•¶å‰æ’­æ”¾ï¼ˆå¦‚æœæœ‰ï¼‰
          if (this.activeState.id) {
            this.stopActiveAnimation();
          }

          // è§¸ç™¼å…¨è¢å¹•æ¨¡æ…‹æ¡†
          const item = target.closest('.gallery-item');
          if (item) {
            const fullscreenIcon = item.querySelector('.fullscreen-icon');
            if (fullscreenIcon) {
              fullscreenIcon.click();
            }
          }
        }

        handleTouchEnd(e) {
          // ç§»å‹•è¨­å‚™é›™æ“Šæª¢æ¸¬
          const target = e.target;
          if ((target.tagName !== "IMG" && target.tagName !== "VIDEO") || !target.dataset.id) return;

          const currentTime = Date.now();
          const timeDiff = currentTime - this.lastTapTime;

          // æª¢æ¸¬æ˜¯å¦ç‚ºé›™æ“Šï¼ˆ300ms å…§ä¸”åŒä¸€ç›®æ¨™ï¼‰
          if (timeDiff < this.doubleTapDelay && this.lastTapTarget === target) {
            // é€™æ˜¯é›™æ“Šï¼
            e.preventDefault(); // é˜²æ­¢è§¸ç™¼å…¶ä»–äº‹ä»¶
            
            // è¨­ç½®æ¨™èªŒï¼Œé˜²æ­¢å¾ŒçºŒçš„ click äº‹ä»¶è§¸ç™¼å–®æ“Š
            this.justDoubleTapped = true;
            
            // å–æ¶ˆå–®æ“Šè¨ˆæ™‚å™¨
            if (this.clickTimer) {
              clearTimeout(this.clickTimer);
              this.clickTimer = null;
            }

            const id = target.dataset.id;
            console.log(`ğŸ“± ç§»å‹•é›™æ“Šå…¨è¢å¹•: ${id}`);

            // åœæ­¢ç•¶å‰æ’­æ”¾ï¼ˆå¦‚æœæœ‰ï¼‰
            if (this.activeState.id) {
              this.stopActiveAnimation();
            }

            // è§¸ç™¼å…¨è¢å¹•æ¨¡æ…‹æ¡†
            const item = target.closest('.gallery-item');
            if (item) {
              const fullscreenIcon = item.querySelector('.fullscreen-icon');
              if (fullscreenIcon) {
                fullscreenIcon.click();
              }
            }

            // é‡ç½®é›™æ“Šæª¢æ¸¬
            this.lastTapTime = 0;
            this.lastTapTarget = null;
            
            // 500ms å¾Œé‡ç½®æ¨™èªŒï¼ˆé˜²æ­¢å½±éŸ¿ä¸‹æ¬¡é»æ“Šï¼‰
            setTimeout(() => {
              this.justDoubleTapped = false;
            }, 500);
          } else {
            // è¨˜éŒ„é€™æ¬¡é»æ“Š
            this.lastTapTime = currentTime;
            this.lastTapTarget = target;
          }
        }

        playAnimation(id, element) {
          const meta = this.indexMap[id];
          if (!meta) {
            console.warn(`âš ï¸  å‹•ç•«ä¸å­˜åœ¨: ${id}`);
            return;
          }

          const type = meta.type || 'webp';
          
          // å¾ ArrayBuffer åˆ‡å‰²å‹•ç•«è³‡æ–™ (Zero-copy)
          const slice = this.buffer.slice(
            this.payloadStart + meta.anim.offset,
            this.payloadStart + meta.anim.offset + meta.anim.length,
          );

          // æ ¹æ“šé¡å‹å»ºç«‹å°æ‡‰çš„ MIME type
          const mimeTypes = {
            'webp': 'image/webp',
            'gif': 'image/gif',
            'mp4': 'video/mp4'
          };

          // å»ºç«‹ Blob URL
          const animUrl = URL.createObjectURL(
            new Blob([slice], { type: mimeTypes[type] || 'image/webp' }),
          );

          // å–å¾—å®¹å™¨ä¸­çš„ img å’Œ video å…ƒç´ 
          const item = element.closest('.gallery-item');
          const imgEl = item.querySelector('img');
          const videoEl = item.querySelector('video');

          // æ ¹æ“šé¡å‹é¸æ“‡ä½¿ç”¨ img æˆ– video
          if (type === 'mp4') {
            imgEl.style.display = 'none';
            videoEl.style.display = 'block';
            videoEl.src = animUrl;
            videoEl.load();
            videoEl.play();
            this.activeState = { id, element: videoEl, animUrl, type };
            this.animationObserver.observe(videoEl);
          } else {
            videoEl.style.display = 'none';
            imgEl.style.display = 'block';
            imgEl.src = animUrl;
            this.activeState = { id, element: imgEl, animUrl, type };
            this.animationObserver.observe(imgEl);
          }
        }

        stopActiveAnimation() {
          if (!this.activeState.id) return;

          const { id, element, animUrl, type } = this.activeState;

          // åœæ­¢ç›£è½
          this.animationObserver.unobserve(element);

          // å–å¾—å®¹å™¨
          const item = element.closest('.gallery-item');
          if (!item) {
            // å¦‚æœæ‰¾ä¸åˆ°å®¹å™¨ï¼ˆå¯èƒ½å·²è¢«ç§»é™¤ï¼‰ï¼Œåªé‡‹æ”¾ URL
            if (animUrl) {
              URL.revokeObjectURL(animUrl);
            }
            this.activeState = { id: null, element: null, animUrl: null, type: null };
            return;
          }

          const imgEl = item.querySelector('img');
          const videoEl = item.querySelector('video');

          // æ ¹æ“šé¡å‹æ¢å¾©ç¸®åœ–ä¸¦å®Œæ•´æ¸…ç†è³‡æº
          const thumbUrl = this.thumbUrls.get(id);
          if (type === 'mp4' && videoEl) {
            // åœæ­¢è¦–é »ä¸¦å®Œæ•´æ¸…ç†
            videoEl.pause();
            videoEl.removeAttribute('src');
            videoEl.load(); // è§¸ç™¼è³‡æºé‡‹æ”¾
            videoEl.style.display = 'none';
            
            if (thumbUrl && imgEl) {
              imgEl.src = thumbUrl;
              imgEl.style.display = 'block';
            }
          } else {
            if (thumbUrl && imgEl) {
              imgEl.src = thumbUrl;
            }
            if (imgEl) imgEl.style.display = 'block';
            if (videoEl) videoEl.style.display = 'none';
          }

          // é‡‹æ”¾å‹•ç•« Blob URL è¨˜æ†¶é«”ï¼ˆé—œéµ GC æ­¥é©Ÿï¼‰
          if (animUrl) {
            URL.revokeObjectURL(animUrl);
          }

          // é‡ç½®ç‹€æ…‹
          this.activeState = { id: null, element: null, animUrl: null, type: null };
        }

        getAnimationUrl(id) {
          const meta = this.indexMap[id];
          if (!meta) return null;

          const type = meta.type || 'webp';
          const mimeTypes = {
            'webp': 'image/webp',
            'gif': 'image/gif',
            'mp4': 'video/mp4'
          };

          const slice = this.buffer.slice(
            this.payloadStart + meta.anim.offset,
            this.payloadStart + meta.anim.offset + meta.anim.length,
          );

          return URL.createObjectURL(new Blob([slice], { type: mimeTypes[type] || 'image/webp' }));
        }

        dispose() {
          console.log("ğŸ—‘ï¸  æ­£åœ¨éŠ·æ¯€ GalleryEngine...");

          // æ¸…é™¤ä»»ä½•å¾…åŸ·è¡Œçš„å–®æ“Šè¨ˆæ™‚å™¨
          if (this.clickTimer) {
            clearTimeout(this.clickTimer);
            this.clickTimer = null;
          }

          // åœæ­¢ç•¶å‰æ’­æ”¾ä¸¦é‡‹æ”¾è³‡æº
          this.stopActiveAnimation();
          
          // ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›£è½å™¨
          this.container.removeEventListener("click", this.handleTap);
          this.container.removeEventListener("dblclick", this.handleDoubleTap);
          this.container.removeEventListener("touchend", this.handleTouchEnd);
          this.animationObserver.disconnect();
          this.virtualObserver.disconnect();

          // é‡‹æ”¾æ‰€æœ‰ç¸®åœ– URLï¼ˆé—œéµ GC æ­¥é©Ÿï¼‰
          for (const url of this.thumbUrls.values()) {
            URL.revokeObjectURL(url);
          }
          this.thumbUrls.clear();
          this.loadedThumbs.clear();
          
          // æ¸…ç†æ‰€æœ‰ video å…ƒç´ ï¼ˆç¢ºä¿é‡‹æ”¾è¨˜æ†¶é«”ï¼‰
          this.renderedItems.forEach(({ element }) => {
            const videoEl = element.querySelector('video');
            if (videoEl) {
              videoEl.pause();
              videoEl.removeAttribute('src');
              videoEl.load();
            }
          });
          this.renderedItems.clear();

          // æ¸…ç©ºè³‡æ–™ç·©è¡å€å¼•ç”¨
          this.buffer = null;
          this.indexMap = null;
          this.allIds = [];
          this.container.innerHTML = "";

          console.log("âœ… éŠ·æ¯€å®Œæˆ - æ‰€æœ‰è³‡æºå·²é‡‹æ”¾ä¸¦æº–å‚™ GC");
        }
      }

      // ==================== ä¸»æ‡‰ç”¨ç¨‹å¼ ====================
      const galleryContainer = document.getElementById("gallery");
      const uploadSection = document.getElementById("upload-section");
      const loadingEl = document.getElementById("loading");
      const fileInput = document.getElementById("file-input");
      const modal = document.getElementById("modal");
      const modalImg = document.getElementById("modal-img");
      const modalVideo = document.getElementById("modal-video");
      const modalClose = document.getElementById("modal-close");
      const destroyBtn = document.getElementById("destroy-btn");

      let engine = new GalleryEngine(galleryContainer);
      let currentModalUrl = null;

      // é»æ“Šè§£é–è¨ˆæ•¸å™¨
      let clickCount = 0;
      const UNLOCK_CLICKS = 20;
      let unlockHandler = null;

      // è§£é–uploadæŒ‰éˆ•åŠŸèƒ½
      function initUnlockFeature() {
        unlockHandler = () => {
          clickCount++;
          console.log(`ğŸ”’ è§£é–é€²åº¦: ${clickCount}/${UNLOCK_CLICKS}`);
          
          if (clickCount >= UNLOCK_CLICKS) {
            // éš±è—loadingï¼Œé¡¯ç¤ºupload
            loadingEl.style.display = 'none';
            uploadSection.style.display = 'flex';
            
            // ç§»é™¤é»æ“Šç›£è½å™¨
            document.body.removeEventListener('click', unlockHandler);
            unlockHandler = null;
            
            console.log('âœ… å·²è§£é–ä¸Šå‚³åŠŸèƒ½');
          }
        };
        
        document.body.addEventListener('click', unlockHandler);
      }

      // åˆå§‹åŒ–è§£é–åŠŸèƒ½
      initUnlockFeature();

      // æª”æ¡ˆé¸æ“‡äº‹ä»¶
      fileInput.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // ç¢ºä¿ç§»é™¤è§£é–ç›£è½å™¨ï¼ˆå¦‚æœé‚„å­˜åœ¨ï¼‰
        if (unlockHandler) {
          document.body.removeEventListener('click', unlockHandler);
          unlockHandler = null;
        }

        uploadSection.style.display = "none";
        loadingEl.style.display = "flex";
        loadingEl.style.cursor = "default"; // æ”¹ç‚ºæ™®é€šé¼ æ¨™

        try {
          await engine.loadFromFile(file);

          loadingEl.style.display = "none";

          // ä½¿ç”¨ console.log è¼¸å‡ºçµ±è¨ˆè³‡è¨Š
          const ids = engine.getAllIds();
          console.log(`âœ… è¼‰å…¥å®Œæˆï¼šå…± ${ids.length} å€‹å‹•ç•«`);
          console.log(
            `ğŸ“Š æª”æ¡ˆå¤§å°ï¼š${(engine.buffer.byteLength / 1024 / 1024).toFixed(2)} MB`,
          );

          // æ¸²æŸ“åœ–åº« (Virtual Scroller)
          renderGallery(ids);

          // é¡¯ç¤ºéŠ·æ¯€æŒ‰éˆ•
          destroyBtn.classList.add("visible");

          // ç›£è½å‹•ç•«ç‹€æ…‹è®ŠåŒ–
          observeActiveState();
        } catch (error) {
          console.error("âŒ è¼‰å…¥å¤±æ•—:", error);
          loadingEl.innerHTML = `
          <div class="error">
            <p>${error.message}</p>
          </div>
        `;
        }
      });

      // æ¸²æŸ“åœ–åº« (Virtual Scroller - åªå‰µå»º DOM éª¨æ¶ï¼Œå»¶é²åŠ è¼‰åœ–ç‰‡)
      function renderGallery(ids) {
        const fragment = document.createDocumentFragment();

        ids.forEach((id) => {
          const item = document.createElement("div");
          item.className = "gallery-item placeholder";
          item.dataset.id = id;

          const img = document.createElement("img");
          img.alt = id;
          img.dataset.id = id;
          // ä¸è¨­ç½® src - ç­‰å¾… IntersectionObserver è§¸ç™¼åŠ è¼‰

          // ç‚º MP4 æ ¼å¼æ·»åŠ  video å…ƒç´ 
          const video = document.createElement("video");
          video.alt = id;
          video.dataset.id = id;
          video.loop = true;
          video.muted = true;
          video.playsInline = true;
          video.style.display = 'none';

          // å³ä¸‹è§’å…¨å±åœ–æ¨™
          const fullscreenIcon = document.createElement("div");
          fullscreenIcon.className = "fullscreen-icon";
          fullscreenIcon.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
          </svg>
        `;
          fullscreenIcon.onclick = (e) => {
            e.stopPropagation();
            openModal(id);
          };

          item.appendChild(img);
          item.appendChild(video);
          item.appendChild(fullscreenIcon);
          fragment.appendChild(item);

          // é–‹å§‹ç›£è½é€™å€‹é …ç›®
          engine.virtualObserver.observe(item);
          engine.renderedItems.set(id, { element: item, isLoaded: false });
        });

        galleryContainer.appendChild(fragment);
        console.log(
          `ğŸ“¦ Virtual Scroller: å·²å‰µå»º ${ids.length} å€‹ DOM å®¹å™¨ (åœ–ç‰‡æŒ‰éœ€åŠ è¼‰)`,
        );
      }

      // é–‹å•Ÿå…¨è¢å¹•æ¨¡æ…‹æ¡†
      function openModal(id) {
        const data = engine.getItemData(id);
        if (!data) return;

        // åœæ­¢ç•¶å‰æ’­æ”¾çš„å‹•ç•«
        engine.stopActiveAnimation();

        // å–å¾—å‹•ç•« URL
        currentModalUrl = engine.getAnimationUrl(id);

        // æ ¹æ“šé¡å‹é¸æ“‡é¡¯ç¤ºå…ƒç´ 
        if (data.type === 'mp4') {
          modalImg.style.display = 'none';
          modalVideo.style.display = 'block';
          modalVideo.src = currentModalUrl;
          modalVideo.load();
          modalVideo.play();
        } else {
          modalVideo.style.display = 'none';
          modalImg.style.display = 'block';
          modalImg.src = currentModalUrl;
        }

        modal.classList.add("active");

        console.log(`â–¶ï¸ æ’­æ”¾ï¼š${id} (${data.width} Ã— ${data.height}) [${data.type.toUpperCase()}]`);

        // é˜²æ­¢èƒŒæ™¯æ»¾å‹•
        document.body.style.overflow = "hidden";
      }

      // é—œé–‰æ¨¡æ…‹æ¡†
      function closeModal() {
        modal.classList.remove("active");
        document.body.style.overflow = "";

        // å®Œæ•´åœæ­¢ä¸¦æ¸…ç†è¦–é »æ’­æ”¾ï¼ˆç¢ºä¿ GCï¼‰
        if (modalVideo.src) {
          modalVideo.pause();
          modalVideo.removeAttribute('src');
          modalVideo.load(); // è§¸ç™¼è³‡æºé‡‹æ”¾
        }

        // æ¸…ç†åœ–ç‰‡
        if (modalImg.src) {
          modalImg.src = "";
        }

        // é‡‹æ”¾å‹•ç•« URLï¼ˆé—œéµ GC æ­¥é©Ÿï¼‰
        if (currentModalUrl) {
          URL.revokeObjectURL(currentModalUrl);
          currentModalUrl = null;
        }

        // é‡ç½®é¡¯ç¤ºç‹€æ…‹
        modalImg.style.display = 'none';
        modalVideo.style.display = 'none';

        console.log("â¹ï¸ åœæ­¢æ’­æ”¾ - è³‡æºå·²é‡‹æ”¾");
      }

      modalClose.addEventListener("click", closeModal);
      modal.addEventListener("click", (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });

      // ESC éµé—œé–‰
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && modal.classList.contains("active")) {
          closeModal();
        }
      });

      // éŠ·æ¯€æŒ‰éˆ•äº‹ä»¶
      destroyBtn.addEventListener("click", () => {
        if (
          confirm("ç¢ºå®šè¦éŠ·æ¯€æ‰€æœ‰è³‡æºå—ï¼Ÿæ­¤æ“ä½œå°‡æ¸…ç©ºæ‰€æœ‰æ•¸æ“šä¸¦é‡‹æ”¾è¨˜æ†¶é«”ã€‚")
        ) {
          closeModal();
          engine.dispose();
          engine = new GalleryEngine(galleryContainer);

          // é‡ç½® UI ç‹€æ…‹ï¼ˆä¸é‡æ–°å•Ÿå‹•è§£é–åŠŸèƒ½ï¼‰
          destroyBtn.classList.remove("visible");
          uploadSection.style.display = "flex";
          loadingEl.style.display = "none";
          fileInput.value = ""; // æ¸…ç©ºæ–‡ä»¶é¸æ“‡ï¼Œå…è¨±é‡æ–°é¸æ“‡åŒä¸€æª”æ¡ˆ

          console.log("â™»ï¸  å¼·åˆ¶ GC: æ‰€æœ‰è³‡æºå·²é‡‹æ”¾ï¼Œç­‰å¾…ç€è¦½å™¨åƒåœ¾å›æ”¶...");
        }
      });

      // ç›£è½å‹•ç•«ç‹€æ…‹è®ŠåŒ–
      function observeActiveState() {
        let lastActiveId = null;

        setInterval(() => {
          const currentId = engine.activeState.id;
          if (currentId !== lastActiveId) {
            if (currentId) {
              console.log(`ğŸ¬ ç•¶å‰æ’­æ”¾ï¼š${currentId}`);
            } else {
              console.log("â¸ï¸ ç„¡æ’­æ”¾ä¸­çš„å‹•ç•«");
            }
            lastActiveId = currentId;
          }
        }, 100);
      }

      // é é¢å¸è¼‰æ™‚æ¸…ç†è³‡æºï¼ˆç¢ºä¿æœ€é«˜æ•ˆèƒ½ GCï¼‰
      window.addEventListener("beforeunload", () => {
        // é—œé–‰æ¨¡æ…‹æ¡†ä¸¦æ¸…ç†
        if (modal.classList.contains('active')) {
          closeModal();
        }
        
        // éŠ·æ¯€å¼•æ“ï¼ˆæœƒè‡ªå‹•æ¸…ç†æ‰€æœ‰è³‡æºï¼‰
        engine.dispose();
        
        // é¡å¤–ç¢ºä¿æ¨¡æ…‹æ¡†è³‡æºè¢«é‡‹æ”¾
        if (modalVideo.src) {
          modalVideo.pause();
          modalVideo.removeAttribute('src');
          modalVideo.load();
        }
        if (modalImg.src) {
          modalImg.src = "";
        }
        if (currentModalUrl) {
          URL.revokeObjectURL(currentModalUrl);
          currentModalUrl = null;
        }
        
        console.log("ğŸšª é é¢å¸è¼‰ - æ‰€æœ‰è³‡æºå·²æ¸…ç†");
      });

      // ==================== PWA æ”¯æ´ ====================
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("sw.js")
            .then((reg) => console.log("âœ… Service Worker è¨»å†ŠæˆåŠŸ", reg))
            .catch((err) => console.log("âŒ Service Worker è¨»å†Šå¤±æ•—", err));
        });
      }
    </script>
  </body>
</html>
