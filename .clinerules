# aiG Gallery - å°ˆæ¡ˆç·¨ç¢¼è¦ç¯„

## ğŸ¯ æ ¸å¿ƒåŸå‰‡

**è¨˜æ†¶é«”ç®¡ç†è‡³ä¸Š** - ä»»ä½•å‰µå»ºè³‡æºçš„æ“ä½œéƒ½å¿…é ˆæœ‰å°æ‡‰çš„æ¸…ç†ç­–ç•¥

## ğŸ“‹ å¼·åˆ¶è¦ç¯„

### 1. Blob URL ç®¡ç†
```javascript
// âœ… æ­£ç¢ºï¼šå‰µå»ºå¾Œå¿…é ˆ revoke
const url = URL.createObjectURL(blob);
// ä½¿ç”¨ url...
URL.revokeObjectURL(url);

// âŒ éŒ¯èª¤ï¼šå¿˜è¨˜ revoke æœƒå°è‡´è¨˜æ†¶é«”æ´©æ¼
const url = URL.createObjectURL(blob);
// ä½¿ç”¨å¾Œæœª revoke
```

**è¦å‰‡**ï¼šæ¯å€‹ `createObjectURL()` éƒ½å¿…é ˆé…å° `revokeObjectURL()`

### 2. è¦–é »å…ƒç´ æ¸…ç†ä¸‰æ­¥é©Ÿ
```javascript
// âœ… å®Œæ•´æ¸…ç†
video.pause();
video.removeAttribute('src');
video.load(); // å¿…é ˆï¼è§¸ç™¼å¯¦éš›è³‡æºé‡‹æ”¾

// âŒ ä¸å®Œæ•´ï¼šåƒ… pause æˆ–è¨­ src='' ä¸å¤ 
video.pause();
video.src = '';
```

**è¦å‰‡**ï¼šåœæ­¢è¦–é »å¿…é ˆåŸ·è¡Œ `pause() + removeAttribute('src') + load()`

### 3. äº‹ä»¶ç›£è½å™¨é…å°
```javascript
// âœ… æ·»åŠ æ™‚ä¿å­˜å¼•ç”¨ï¼ŒéŠ·æ¯€æ™‚ç§»é™¤
this.handleClick = this.handleClick.bind(this);
element.addEventListener('click', this.handleClick);
// åœ¨ dispose() ä¸­ï¼š
element.removeEventListener('click', this.handleClick);

// âŒ ä½¿ç”¨åŒ¿åå‡½æ•¸ç„¡æ³•ç§»é™¤
element.addEventListener('click', () => { });
```

**è¦å‰‡**ï¼šæ‰€æœ‰ `addEventListener` å¿…é ˆåœ¨ `dispose()` ä¸­æœ‰å°æ‡‰çš„ `removeEventListener`

### 4. Observer æ¸…ç†
```javascript
// âœ… å‰µå»ºæ™‚ä¿å­˜ï¼ŒéŠ·æ¯€æ™‚ disconnect
this.observer = new IntersectionObserver(...);
// åœ¨ dispose() ä¸­ï¼š
this.observer.disconnect();

// âŒ å¿˜è¨˜ disconnect
this.observer = new IntersectionObserver(...);
// å¾æœª disconnect
```

**è¦å‰‡**ï¼šæ‰€æœ‰ Observer å¿…é ˆåœ¨ `dispose()` ä¸­ `disconnect()`

### 5. è¨ˆæ™‚å™¨æ¸…ç†
```javascript
// âœ… å‰µå»ºæ™‚ä¿å­˜ï¼ŒéŠ·æ¯€æ™‚æ¸…é™¤
this.timer = setTimeout(...);
// åœ¨ dispose() æˆ–åˆ‡æ›æ™‚ï¼š
clearTimeout(this.timer);
this.timer = null;

// âŒ æœªæ¸…é™¤è¨ˆæ™‚å™¨
this.timer = setTimeout(...);
// å¾æœª clearTimeout
```

**è¦å‰‡**ï¼šæ‰€æœ‰ `setTimeout/setInterval` å¿…é ˆæœ‰å°æ‡‰çš„ `clear` èª¿ç”¨

### 6. å–®æ“Šé›™æ“Šè¡çªè™•ç†
```javascript
// âœ… æ¡Œé¢ï¼šå»¶é²å–®æ“Š 250ms
handleTap() {
  this.clickTimer = setTimeout(() => {
    // å–®æ“Šæ“ä½œ
  }, 250);
}

handleDoubleTap() {
  if (this.clickTimer) {
    clearTimeout(this.clickTimer);
    this.clickTimer = null;
  }
  // é›™æ“Šæ“ä½œ
}

// âœ… ç§»å‹•ï¼šä½¿ç”¨ touchend + 300ms åˆ¤æ–·
handleTouchEnd(e) {
  const now = Date.now();
  if (now - this.lastTapTime < 300) {
    this.justDoubleTapped = true;
    // é›™æ“Šæ“ä½œ
  }
  this.lastTapTime = now;
}
```

**è¦å‰‡**ï¼š
- æ¡Œé¢å–®æ“Šå»¶é² 250ms é¿å…é›™æ“Šè¡çª
- ç§»å‹•ä½¿ç”¨ `touchend` äº‹ä»¶ï¼Œ300ms å…§åˆ¤å®šç‚ºé›™æ“Š
- é›™æ“Šå¾Œè¨­ç½®æ¨™èªŒé˜²æ­¢è§¸ç™¼ click äº‹ä»¶

### 7. CSS ç§»å‹•å„ªåŒ–
```css
/* âœ… ç¦ç”¨é›™æ“Šç¸®æ”¾ä»¥æ”¯æŒè‡ªå®šç¾©é›™æ“Š */
.interactive-element {
  touch-action: manipulation;
}

/* âŒ ä½¿ç”¨é è¨­å€¼æœƒèˆ‡é›™æ“Šå…¨å±è¡çª */
.interactive-element {
  /* æ²’æœ‰è¨­ç½® touch-action */
}
```

**è¦å‰‡**ï¼šéœ€è¦é›™æ“Šäº¤äº’çš„å…ƒç´ å¿…é ˆè¨­ç½® `touch-action: manipulation`

## ğŸ”§ dispose() æ–¹æ³•æª¢æŸ¥æ¸…å–®

æ¯å€‹å¼•æ“/çµ„ä»¶çš„ `dispose()` å¿…é ˆåŒ…å«ï¼š

```javascript
dispose() {
  // 1. æ¸…ç†è¨ˆæ™‚å™¨
  if (this.clickTimer) clearTimeout(this.clickTimer);
  
  // 2. åœæ­¢ç•¶å‰æ’­æ”¾
  this.stopActiveAnimation();
  
  // 3. ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›£è½å™¨
  this.container.removeEventListener('click', this.handleTap);
  this.container.removeEventListener('dblclick', this.handleDoubleTap);
  this.container.removeEventListener('touchend', this.handleTouchEnd);
  
  // 4. Disconnect æ‰€æœ‰ observers
  this.animationObserver?.disconnect();
  this.virtualObserver?.disconnect();
  
  // 5. Revoke æ‰€æœ‰ Blob URLs
  for (const url of this.thumbUrls.values()) {
    URL.revokeObjectURL(url);
  }
  
  // 6. æ¸…ç†æ‰€æœ‰è¦–é »å…ƒç´ 
  this.renderedItems.forEach(({ element }) => {
    const video = element.querySelector('video');
    if (video) {
      video.pause();
      video.removeAttribute('src');
      video.load();
    }
  });
  
  // 7. æ¸…ç©ºæ‰€æœ‰é›†åˆ
  this.thumbUrls.clear();
  this.renderedItems.clear();
  
  // 8. è§£é™¤å¼•ç”¨
  this.buffer = null;
  this.indexMap = null;
  this.allIds = [];
  
  // 9. æ¸…ç©º DOM
  this.container.innerHTML = '';
}
```

## ğŸš« ç¦æ­¢äº‹é …

1. âŒ åœ¨è¿´åœˆä¸­å‰µå»º Blob URL è€Œæ²’æœ‰ç«‹å³æ¸…ç†è¨ˆç•«
2. âŒ ç›´æ¥è¨­ç½® `video.src = blob` è€Œéä½¿ç”¨ Blob URL
3. âŒ ä½¿ç”¨åŒ¿åå‡½æ•¸ä½œç‚ºäº‹ä»¶ç›£è½å™¨
4. âŒ åœ¨å…¨å±€ä½œç”¨åŸŸå‰µå»º Observer è€Œæœªç®¡ç†
5. âŒ è¤‡è£½å¤§å‹ ArrayBuffer è€Œéä½¿ç”¨ slice
6. âŒ é è¼‰æ‰€æœ‰å‹•ç•«ï¼ˆæ‡‰ä½¿ç”¨ JIT åŠ è¼‰ï¼‰
7. âŒ åœ¨ç§»å‹•è¨­å‚™ä¸Šåƒ…ä½¿ç”¨ click/dblclick äº‹ä»¶

## ğŸ“Š æ€§èƒ½å„ªåŒ–ç­–ç•¥

### Virtual Scrolling
- åªæ¸²æŸ“å¯è¦‹å€åŸŸ + ç·©è¡å€ï¼ˆ200pxï¼‰
- é›¢é–‹è¦–çª—ç«‹å³å¸è¼‰è³‡æº

### JIT Loading
- é»æ“Šæ™‚æ‰å‰µå»ºå‹•ç•« Blob
- åˆ‡æ›æ™‚ç«‹å³é‡‹æ”¾èˆŠå‹•ç•«
- åŒæ™‚æœ€å¤šä¸€å€‹å‹•ç•«æ’­æ”¾

### Auto-Stop
- ä½¿ç”¨ IntersectionObserver ç›£è½å¯è¦‹æ€§
- é›¢é–‹è¦–çª—è‡ªå‹•åœæ­¢å‹•ç•«

### Zero-Copy
```javascript
// âœ… ä½¿ç”¨ slice å…±äº«è¨˜æ†¶é«”
const slice = buffer.slice(offset, offset + length);

// âŒ ä¸è¦è¤‡è£½æ•´å€‹ buffer
const copy = new Uint8Array(buffer).slice(offset, offset + length);
```

## ğŸ” Code Review é‡é»

å¯©æŸ¥ä»£ç¢¼æ™‚å¿…é ˆæª¢æŸ¥ï¼š

1. æ¯å€‹ `createObjectURL` æ˜¯å¦æœ‰å°æ‡‰çš„ `revokeObjectURL`
2. æ¯å€‹ `addEventListener` æ˜¯å¦åœ¨ dispose ä¸­ç§»é™¤
3. æ¯å€‹ `new IntersectionObserver` æ˜¯å¦æœ‰ disconnect
4. æ¯å€‹ `setTimeout` æ˜¯å¦æœ‰ clearTimeout
5. è¦–é »åœæ­¢æ˜¯å¦åŸ·è¡Œå®Œæ•´ä¸‰æ­¥é©Ÿ
6. dispose æ–¹æ³•æ˜¯å¦å®Œæ•´
7. ç§»å‹•è¨­å‚™äº¤äº’æ˜¯å¦ä½¿ç”¨ touch äº‹ä»¶
8. æ˜¯å¦è¨­ç½®äº†æ­£ç¢ºçš„ touch-action CSS

## ğŸ“± ç§»å‹•è¨­å‚™ç‰¹æ®Šè™•ç†

```javascript
// âœ… åŒæ™‚æ”¯æŒæ¡Œé¢å’Œç§»å‹•
element.addEventListener('click', this.handleTap);      // æ¡Œé¢å–®æ“Š
element.addEventListener('dblclick', this.handleDoubleTap); // æ¡Œé¢é›™æ“Š
element.addEventListener('touchend', this.handleTouchEnd);  // ç§»å‹•é›™æ“Š

// CSS
.element {
  touch-action: manipulation; /* ç¦ç”¨é›™æ“Šç¸®æ”¾ */
}
```

## ğŸ“ åƒè€ƒè³‡æº

- [MDN: URL.createObjectURL](https://developer.mozilla.org/en-US/docs/Web/API/URL/createObjectURL)
- [MDN: HTMLMediaElement.load](https://developer.mozilla.org/en-US/docs/Web/API/HTMLMediaElement/load)
- [Chrome DevTools: Memory Profiler](https://developer.chrome.com/docs/devtools/memory-problems/)
